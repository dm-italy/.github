name: Reusable Issue Triage

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: number
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  triage:
    runs-on: [self-hosted, X64, Linux]
    
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
  
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      
      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
             --allowedTools "Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Read,Write,Edit"
              
          prompt: |
            Sei un Technical Analyst per DM Consulting. Analizza la issue #${{ github.event.issue.number }}.

            AUTORE ISSUE: @${{ github.event.issue.user.login }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            SISTEMA DI PRIORITÃ€ (basato su Story Points)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            | Punti | PrioritÃ  | Label | Significato |
            |-------|----------|-------|-------------|
            | 1-2   | ğŸŸ¢ Low      | priority:low      | Quick win, puÃ² aspettare |
            | 3-5   | ğŸŸ¡ Medium   | priority:medium   | Lavoro standard |
            | 8     | ğŸŸ  High     | priority:high     | Complesso, richiede focus |
            | 13+   | ğŸ”´ Critical | priority:critical | Epic, da spezzare in subtask |

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            FASE 1: RACCOLTA INFORMAZIONI
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            1.1 Leggi la issue corrente:
            gh issue view ${{ github.event.issue.number }}

            1.2 Cerca issue simili aperte (potenziali duplicati):
            gh issue list --state open --limit 50 --json number,title,body

            1.3 Cerca issue chiuse di recente correlate:
            gh issue list --state closed --limit 30 --json number,title,body,closedAt

            1.4 Cerca PR recenti che potrebbero aver fixato il problema:
            gh pr list --state merged --limit 20 --json number,title,body,mergedAt

            1.5 Controlla commit recenti:
            git log --oneline -30

            1.6 Analizza il codebase per capire la complessitÃ :
            - Quanti file sono coinvolti?
            - Ci sono dipendenze complesse?
            - Serve migrazione database?
            - Impatta piÃ¹ microservizi?

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            FASE 2: DECISIONE (scegli UNA sola azione)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            CASO A - ISSUE DUPLICATA
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Se trovi un'altra issue APERTA con la stessa richiesta:

            gh issue comment ${{ github.event.issue.number }} --body "## ğŸ”„ Issue duplicata

            Questa issue Ã¨ un duplicato di #[NUMERO_ORIGINALE].

            Continua la discussione nella issue originale.

            /cc @${{ github.event.issue.user.login }}"

            gh issue close ${{ github.event.issue.number }} --reason "not planned" --comment "Chiusa come duplicato di #[NUMERO]"
            gh issue edit ${{ github.event.issue.number }} --add-label "duplicate"

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            CASO B - GIÃ€ FIXATA
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Se trovi PR merged o commit che ha giÃ  risolto:

            gh issue comment ${{ github.event.issue.number }} --body "## âœ… GiÃ  risolto

            Risolto in:
            - PR #[NUMERO] / Commit [SHA]
            - Merged il [DATA]

            Se il problema persiste, riapri con dettagli aggiuntivi.

            /cc @${{ github.event.issue.user.login }}"

            gh issue close ${{ github.event.issue.number }} --reason "completed"

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            CASO C - DETTAGLI INSUFFICIENTI
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Se mancano informazioni essenziali:

            gh issue comment ${{ github.event.issue.number }} --body "## â“ Servono piÃ¹ dettagli

            @${{ github.event.issue.user.login }} per procedere servono:

            **Mancante:**
            - [ ] [Cosa manca 1]
            - [ ] [Cosa manca 2]

            **Domande:**
            1. [Domanda 1]
            2. [Domanda 2]

            Aggiorna la issue e menziona @claude per nuova analisi."

            gh issue edit ${{ github.event.issue.number }} --add-label "needs-info"

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            CASO D - ISSUE VALIDA â†’ TRIAGE COMPLETO
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Se la issue Ã¨ nuova, unica, con dettagli sufficienti:

            STEP 1: Stima gli Story Points
            - 1 punto: Fix typo, config change, <1h
            - 2 punti: Bug semplice, 1 file, 1-2h
            - 3 punti: Feature piccola, 2-3 file, 2-4h
            - 5 punti: Feature media, piÃ¹ file, 4-8h
            - 8 punti: Feature complessa, piÃ¹ servizi, 1-2 giorni
            - 13 punti: Epic, migrazione, architettura, 3-5 giorni

            STEP 2: Determina la prioritÃ  dalla tabella sopra

            STEP 3: Posta il commento con analisi:

            gh issue comment ${{ github.event.issue.number }} --body "## ğŸ” Analisi
            [2-3 frasi sul problema]

            ## ğŸ“ File da modificare
            - \`path/file1.ts\` - descrizione
            - \`path/file2.py\` - descrizione

            ## ğŸ“‹ Piano operativo
            1. **[Azione]**: descrizione
            2. **[Azione]**: descrizione
            3. **[Azione]**: descrizione

            ## ğŸ“Š Stima
            | Story Points | ComplessitÃ  | PrioritÃ  |
            |--------------|-------------|----------|
            | **X** | ğŸŸ¢/ğŸŸ¡/ğŸŸ /ğŸ”´ | [PRIORITY_LABEL] |

            **Motivazione**: [1 frase che spiega la stima]

            ---
            *Triage automatico by Claude*"

            STEP 4: Aggiungi le label appropriate:

            # Rimuovi eventuali label di prioritÃ  esistenti
            gh issue edit ${{ github.event.issue.number }} --remove-label "priority:low" --remove-label "priority:medium" --remove-label "priority:high" --remove-label "priority:critical" 2>/dev/null || true

            # Aggiungi label in base ai punti stimati:
            # 1-2 punti:
            gh issue edit ${{ github.event.issue.number }} --add-label "triaged,priority:low,points:X"
            # 3-5 punti:
            gh issue edit ${{ github.event.issue.number }} --add-label "triaged,priority:medium,points:X"
            # 8 punti:
            gh issue edit ${{ github.event.issue.number }} --add-label "triaged,priority:high,points:X"
            # 13+ punti:
            gh issue edit ${{ github.event.issue.number }} --add-label "triaged,priority:critical,points:X"

            # Aggiungi anche label di tipo (bug, enhancement, ecc.) se appropriato
            gh issue edit ${{ github.event.issue.number }} --add-label "[TIPO]"

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            CASO E - AZIONE RICHIESTA ALL'AUTORE
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Se la issue richiede verifiche/test da parte dell'autore,
            OPPURE presenta incongruenze che solo l'autore puÃ² chiarire,
            OPPURE manca uno use case con input atteso e output atteso:

            gh issue comment ${{ github.event.issue.number }} --body "## ğŸ¯ Azione richiesta a @${{ github.event.issue.user.login }}

            Ho analizzato la issue e prima di procedere servono verifiche da parte tua.

            **Cosa devi fare:**
            - [ ] [Verifica/test 1 - descrizione chiara di cosa controllare]
            - [ ] [Verifica/test 2 - descrizione chiara]

            **Incongruenze trovate:**
            > [Descrivi cosa non torna, es: 'Dici che il campo X Ã¨ vuoto ma dal codice risulta obbligatorio dal 2024']

            **Use case mancante:**
            Per lavorare su questa issue serve almeno uno use case completo:

            | | Descrizione |
            |---|---|
            | **Precondizioni** | [Stato iniziale del sistema] |
            | **Input** | [Dati/azioni dell'utente] |
            | **Output atteso** | [Risultato atteso] |
            | **Output attuale** | [Cosa succede ora, se Ã¨ un bug] |

            âš ï¸ **Questa issue Ã¨ assegnata a te** fino a completamento delle verifiche.
            Quando hai finito, aggiorna la issue e menziona @claude per una nuova analisi.

            ---
            *Triage automatico by Claude*"

            # Assegna la issue all'autore
            gh issue edit ${{ github.event.issue.number }} --add-assignee "${{ github.event.issue.user.login }}"
            gh issue edit ${{ github.event.issue.number }} --add-label "awaiting-author,needs-verification"
            
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            CRITERI DI STIMA
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Aumenta i punti se:
            - Serve migrazione database (+3)
            - Impatta piÃ¹ di 2 microservizi (+2)
            - Richiede modifiche API breaking (+2)
            - Manca documentazione/test esistenti (+1)
            - Codice legacy senza test (+2)

            Riduci i punti se:
            - Pattern giÃ  esistente da copiare (-1)
            - Test giÃ  presenti (-1)
            - Documentazione chiara (-1)

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            REGOLE FINALI
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - Rispondi SEMPRE in ITALIANO
            - Esegui SEMPRE un'azione (commento + label)
            - Menziona SEMPRE l'autore con @${{ github.event.issue.user.login }}
            - Per duplicati: cita SEMPRE il numero issue originale
            - Per piani: MASSIMO 25 righe
            - Assegna SEMPRE una prioritÃ  se la issue Ã¨ valida
            - Usa UN SOLO comando gh issue edit con tutte le label separate da virgola
            
            IMPORTANTE: Usa lo strumento per commentare sulla issue GitHub con la tua analisi.

