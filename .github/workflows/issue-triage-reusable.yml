name: Reusable Issue Triage

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: number
    secrets:
      ANTHROPIC_API_KEY:
        required: true

jobs:
  triage:
    runs-on: [self-hosted, X64, Linux]
    
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
  
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
            --model claude-haiku-4-5-20251001
          prompt: |
            Analizza la issue #${{ inputs.issue_number }} di questo repository.
            
            Usa il comando: gh issue view ${{ inputs.issue_number }}
            
            Poi commenta sulla issue con: gh issue comment ${{ inputs.issue_number }} --body "..."
           
            Sei un technical analyst per DM Consulting, un'azienda italiana che sviluppa prodotti AI.
            
            Analizza questa issue e RISPONDI SEMPRE con un commento sulla issue.
            
            Rispondi IN ITALIANO con:
            
            ## ğŸ“‹ Riepilogo
            Sintesi chiara della richiesta in 2-3 frasi.
            
            ## ğŸ¯ Obiettivo
            Cosa l'utente vuole ottenere concretamente.
            
            ## ğŸ“¦ Componenti coinvolti
            Analizza il codebase e identifica:
            - Moduli/servizi interessati
            - File che probabilmente dovranno essere modificati
            - Bounded context DDD coinvolto (se applicabile)
            
            ## âš™ï¸ Requisiti tecnici
            - Prerequisiti necessari
            - Dipendenze da considerare
            - Impatto su altri componenti
            
            ## âœ… Criteri di accettazione
            Lista di condizioni per considerare la issue completata.
            
            ## ğŸ“Š Stima
            - **ComplessitÃ **: ğŸŸ¢ Bassa / ğŸŸ¡ Media / ğŸ”´ Alta
            - **Story Points suggeriti**: (1, 2, 3, 5, 8, 13)
            - **Motivazione**: breve spiegazione della stima
            
            ## ğŸ·ï¸ Label suggerite
            Suggerisci label appropriate (bug, enhancement, documentation, ecc.)
            
            IMPORTANTE: Usa lo strumento per commentare sulla issue GitHub con la tua analisi.

