name: Reusable Issue Triage

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: number
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  triage:
    runs-on: [self-hosted, X64, Linux]
    
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
  
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      
      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
             --allowedTools "Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Read,Write,Edit"
              
          prompt: |
            Analizza la issue #${{ github.event.issue.number }} e posta un commento con il PIANO DI IMPLEMENTAZIONE.

            STEP 1: Leggi la issue
            gh issue view ${{ github.event.issue.number }}

            STEP 2: Analizza il codebase per capire i file coinvolti

            STEP 3: Posta il commento con questo comando:
            gh issue comment ${{ github.event.issue.number }} --body "IL_TUO_COMMENTO"

            Il commento DEVE essere in ITALIANO e seguire ESATTAMENTE questo formato compatto:

            ---
            ## üîç Analisi
            [2-3 frasi che spiegano il problema]

            ## üìÅ File da modificare
            - `path/to/file1.ts` - descrizione breve
            - `path/to/file2.py` - descrizione breve

            ## üìã Piano operativo
            1. **[Azione 1]**: descrizione concisa
            2. **[Azione 2]**: descrizione concisa
            3. **[Azione 3]**: descrizione concisa

            ## ‚è±Ô∏è Stima: X punti | üü¢/üü°/üî¥ Complessit√†
            ---

            REGOLE:
            - Massimo 30 righe totali
            - No spiegazioni verbose
            - Focus su COSA FARE, non su analisi teorica
            - Il piano deve essere eseguibile da uno sviluppatore e da claude code
            
            IMPORTANTE: Usa lo strumento per commentare sulla issue GitHub con la tua analisi.

